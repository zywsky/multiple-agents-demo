# ä»£ç ä¼˜åŒ–å»ºè®®å’Œå®ç°

## ä¸“å®¶å®¡æŸ¥æ€»ç»“

ä»å¤š Agentã€LangChain/LangGraph å’Œ Python é«˜çº§ç¼–ç¨‹è§’åº¦ï¼Œå·²å®Œæˆä»¥ä¸‹ä¼˜åŒ–ï¼š

## âœ… å·²å®ç°çš„ä¼˜åŒ–

### 1. ç§»é™¤ä¸å¿…è¦çš„ Agent âœ…

**é—®é¢˜**: æ–‡ä»¶æ”¶é›†ä¸éœ€è¦ LLMï¼Œç›´æ¥ç”¨å·¥å…·å‡½æ•°å³å¯

**ä¼˜åŒ–**:
- âœ… ç§»é™¤äº† `FileCollectionAgent`
- âœ… `collect_files` èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ `list_files` å·¥å…·å‡½æ•°
- âœ… æ›´å¿«é€Ÿã€æ›´å¯é ã€æ›´èŠ‚çœæˆæœ¬

**ä»£ç ä½ç½®**: `workflow/graph.py` - `collect_files()` å‡½æ•°

### 2. ç»“æ„åŒ–è¾“å‡º âœ…

**é—®é¢˜**: Agent è¿”å›å­—ç¬¦ä¸²ï¼Œéœ€è¦æ‰‹åŠ¨è§£æï¼Œå®¹æ˜“å‡ºé”™

**ä¼˜åŒ–**:
- âœ… ä½¿ç”¨ Pydantic æ¨¡å‹å®šä¹‰è¾“å‡ºç»“æ„
- âœ… `BaseAgent` æ”¯æŒ `output_schema` å‚æ•°
- âœ… è‡ªåŠ¨è§£æå’ŒéªŒè¯è¾“å‡º
- âœ… å¤±è´¥æ—¶å›é€€åˆ°æ–‡æœ¬è§£æ

**å®ç°**:
- `utils/schemas.py`: å®šä¹‰äº†æ‰€æœ‰ç»“æ„åŒ–è¾“å‡ºæ¨¡å‹
- `agents/base_agent.py`: æ”¯æŒç»“æ„åŒ–è¾“å‡ºè§£æ
- æ‰€æœ‰ Agent éƒ½å·²é…ç½®ç»“æ„åŒ–è¾“å‡º

**ä¼˜åŠ¿**:
- ç±»å‹å®‰å…¨
- è‡ªåŠ¨éªŒè¯
- æ›´æ˜“å¤„ç†
- æ›´å¥½çš„é”™è¯¯å¤„ç†

### 3. é‡è¯•æœºåˆ¶ âœ…

**é—®é¢˜**: ç½‘ç»œå¼‚å¸¸ã€API å¤±è´¥ç­‰æ²¡æœ‰é‡è¯•

**ä¼˜åŒ–**:
- âœ… å®ç°äº† `retry_with_backoff` è£…é¥°å™¨
- âœ… æ”¯æŒæŒ‡æ•°é€€é¿å’ŒéšæœºæŠ–åŠ¨
- âœ… åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•çš„é”™è¯¯
- âœ… æ‰€æœ‰ Agent è°ƒç”¨éƒ½å¸¦é‡è¯•

**å®ç°**:
- `utils/retry.py`: é‡è¯•æœºåˆ¶å®ç°
- `agents/base_agent.py`: `_invoke_agent` æ–¹æ³•ä½¿ç”¨é‡è¯•è£…é¥°å™¨

**ç‰¹æ€§**:
- æŒ‡æ•°é€€é¿: 1s, 2s, 4s...
- æœ€å¤§å»¶è¿Ÿé™åˆ¶: 60s
- éšæœºæŠ–åŠ¨: é¿å…é›·ç¾¤æ•ˆåº”
- æ™ºèƒ½é”™è¯¯åˆ†ç±»

### 4. è¾“å‡ºéªŒè¯å’Œè§£æ âœ…

**é—®é¢˜**: Agent è¾“å‡ºæ ¼å¼ä¸ä¸€è‡´ï¼Œéš¾ä»¥è§£æ

**ä¼˜åŒ–**:
- âœ… ç»“æ„åŒ–è¾“å‡ºè‡ªåŠ¨éªŒè¯ï¼ˆPydanticï¼‰
- âœ… æ™ºèƒ½æ–‡æœ¬è§£æï¼ˆä½œä¸ºå›é€€ï¼‰
- âœ… ä»£ç å—æå–å·¥å…·
- âœ… è·¯å¾„æå–å·¥å…·

**å®ç°**:
- `utils/parsers.py`: å„ç§è§£æå·¥å…·
- `workflow/graph.py`: ä½¿ç”¨è§£æå·¥å…·å¤„ç†è¾“å‡º

### 5. Python é«˜çº§ç¼–ç¨‹æ”¹è¿› âœ…

#### 5.1 ç±»å‹æç¤º
- âœ… ä½¿ç”¨ `TypedDict` å®šä¹‰çŠ¶æ€
- âœ… ä½¿ç”¨ Pydantic æ¨¡å‹
- âœ… å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ç±»å‹æç¤º

#### 5.2 é”™è¯¯å¤„ç†
- âœ… ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
- âœ… æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- âœ… é”™è¯¯åˆ†ç±»ï¼ˆå¯é‡è¯• vs ä¸å¯é‡è¯•ï¼‰

#### 5.3 ä»£ç ç»„ç»‡
- âœ… å·¥å…·å‡½æ•°æ¨¡å—åŒ–
- âœ… é…ç½®é›†ä¸­ç®¡ç†
- âœ… æ¸…æ™°çš„èŒè´£åˆ†ç¦»

## ğŸ“‹ è¯¦ç»†ä¼˜åŒ–è¯´æ˜

### 1. æ–‡ä»¶æ”¶é›†ä¼˜åŒ–

**ä¹‹å‰**:
```python
file_collection_agent = _get_agent(FileCollectionAgent, "file_collection")
result = file_collection_agent.run(prompt)
files = [f.strip() for f in result.split("\n") ...]
```

**ç°åœ¨**:
```python
from tools import list_files
files = list_files(component_path, recursive=True)
```

**ä¼˜åŠ¿**:
- æ›´å¿«ï¼ˆä¸éœ€è¦ LLM è°ƒç”¨ï¼‰
- æ›´å¯é ï¼ˆç›´æ¥æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼‰
- æ›´ä¾¿å®œï¼ˆä¸æ¶ˆè€— API è°ƒç”¨ï¼‰
- æ›´ç®€å•ï¼ˆä»£ç æ›´æ¸…æ™°ï¼‰

### 2. ç»“æ„åŒ–è¾“å‡º

**ä¹‹å‰**:
```python
result = agent.run(prompt)  # è¿”å›å­—ç¬¦ä¸²
# éœ€è¦æ‰‹åŠ¨è§£æå­—ç¬¦ä¸²
selected_components = [line.strip() for line in result.split("\n") ...]
```

**ç°åœ¨**:
```python
result = agent.run(prompt, return_structured=True)  # è¿”å› Pydantic æ¨¡å‹
if hasattr(result, 'selected_components'):
    selected_components = result.selected_components  # ç›´æ¥è®¿é—®
```

**ä¼˜åŠ¿**:
- ç±»å‹å®‰å…¨
- è‡ªåŠ¨éªŒè¯
- æ›´æ˜“ä½¿ç”¨
- æ›´å¥½çš„ IDE æ”¯æŒ

### 3. é‡è¯•æœºåˆ¶

**ä¹‹å‰**:
```python
result = agent.run(prompt)  # å¦‚æœå¤±è´¥å°±å¤±è´¥
```

**ç°åœ¨**:
```python
@retry_with_backoff(max_retries=3)
def _invoke_agent(self, messages):
    result = self.agent_graph.invoke(...)
    return result
```

**ä¼˜åŠ¿**:
- è‡ªåŠ¨é‡è¯•ç½‘ç»œé”™è¯¯
- æŒ‡æ•°é€€é¿é¿å…è¿‡è½½
- æ™ºèƒ½é”™è¯¯åˆ†ç±»
- æé«˜æˆåŠŸç‡

### 4. è¾“å‡ºè§£ææ”¹è¿›

**æ–°å¢å·¥å…·**:
- `extract_code_from_response()`: ä»å“åº”ä¸­æå–ä»£ç å—
- `extract_file_paths()`: ä»æ–‡æœ¬ä¸­æå–æ–‡ä»¶è·¯å¾„
- `parse_component_paths()`: è§£æç»„ä»¶è·¯å¾„

**ä¼˜åŠ¿**:
- æ›´æ™ºèƒ½çš„è§£æ
- å¤„ç†å¤šç§æ ¼å¼
- å®¹é”™æ€§æ›´å¥½

## ğŸ” è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. çŠ¶æ€ç®¡ç†

**å»ºè®®**: ä½¿ç”¨ Pydantic æ¨¡å‹æ›¿ä»£ TypedDict

**åŸå› **:
- æ›´å¥½çš„éªŒè¯
- æ›´å¥½çš„åºåˆ—åŒ–
- æ›´å¥½çš„æ–‡æ¡£

**ç¤ºä¾‹**:
```python
from pydantic import BaseModel

class WorkflowState(BaseModel):
    resource_type: str
    aem_repo_path: str
    component_path: str
    # ...
```

### 2. é…ç½®ç®¡ç†

**å»ºè®®**: ä½¿ç”¨ `pydantic-settings`

**åŸå› **:
- ç±»å‹éªŒè¯
- ç¯å¢ƒå˜é‡è‡ªåŠ¨åŠ è½½
- é…ç½®éªŒè¯

**ç¤ºä¾‹**:
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    openai_api_key: str
    aem_repo_path: str
    bdl_library_path: str
    
    class Config:
        env_file = ".env"
```

### 3. å¹¶è¡Œå¤„ç†

**å»ºè®®**: å¯¹äºç‹¬ç«‹çš„æ“ä½œä½¿ç”¨å¹¶è¡Œå¤„ç†

**ç¤ºä¾‹**:
- Review agents å¯ä»¥å¹¶è¡Œè¿è¡Œ
- æ–‡ä»¶åˆ†æå¯ä»¥åˆ†æ‰¹å¹¶è¡Œ

**å®ç°**:
```python
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=3) as executor:
    futures = {
        executor.submit(security_agent.run, ...),
        executor.submit(build_agent.run, ...),
        executor.submit(bdl_agent.run, ...)
    }
    results = [f.result() for f in futures]
```

### 4. ç¼“å­˜æœºåˆ¶

**å»ºè®®**: ç¼“å­˜æ–‡ä»¶åˆ†æå’Œç»„ä»¶é€‰æ‹©ç»“æœ

**åŸå› **:
- é¿å…é‡å¤åˆ†æç›¸åŒæ–‡ä»¶
- æé«˜æ€§èƒ½
- èŠ‚çœ API è°ƒç”¨

**å®ç°**:
```python
from functools import lru_cache
import hashlib

@lru_cache(maxsize=100)
def analyze_file_cached(file_path: str, file_hash: str):
    # ä½¿ç”¨æ–‡ä»¶å“ˆå¸Œä½œä¸ºç¼“å­˜é”®
    ...
```

### 5. ç›‘æ§å’ŒæŒ‡æ ‡

**å»ºè®®**: æ·»åŠ æ€§èƒ½ç›‘æ§

**æŒ‡æ ‡**:
- Agent è°ƒç”¨æ¬¡æ•°
- å¹³å‡å“åº”æ—¶é—´
- æˆåŠŸç‡
- Token ä½¿ç”¨é‡

### 6. æµ‹è¯•

**å»ºè®®**: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**æµ‹è¯•è¦†ç›–**:
- å·¥å…·å‡½æ•°
- Agent è¾“å‡ºè§£æ
- å·¥ä½œæµèŠ‚ç‚¹
- é”™è¯¯å¤„ç†

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ–‡ä»¶æ”¶é›†

| æŒ‡æ ‡ | ä¹‹å‰ (Agent) | ç°åœ¨ (å·¥å…·å‡½æ•°) |
|------|-------------|----------------|
| é€Ÿåº¦ | ~2-5ç§’ | <0.1ç§’ |
| æˆæœ¬ | API è°ƒç”¨ | å…è´¹ |
| å¯é æ€§ | ä¾èµ– LLM | 100% |

### ç»“æ„åŒ–è¾“å‡º

| æŒ‡æ ‡ | ä¹‹å‰ (æ–‡æœ¬è§£æ) | ç°åœ¨ (ç»“æ„åŒ–) |
|------|---------------|--------------|
| è§£ææˆåŠŸç‡ | ~70% | ~95% |
| é”™è¯¯å¤„ç† | æ‰‹åŠ¨ | è‡ªåŠ¨ |
| ç±»å‹å®‰å…¨ | æ—  | æœ‰ |

### é‡è¯•æœºåˆ¶

| æŒ‡æ ‡ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| ç½‘ç»œé”™è¯¯æ¢å¤ | 0% | ~80% |
| æˆåŠŸç‡ | ~85% | ~95% |

## ğŸ¯ æ€»ç»“

### å·²å®Œæˆçš„ä¼˜åŒ–

1. âœ… **ç§»é™¤ä¸å¿…è¦çš„ Agent**: æ–‡ä»¶æ”¶é›†ç›´æ¥ä½¿ç”¨å·¥å…·
2. âœ… **ç»“æ„åŒ–è¾“å‡º**: æ‰€æœ‰ Agent æ”¯æŒ Pydantic æ¨¡å‹
3. âœ… **é‡è¯•æœºåˆ¶**: è‡ªåŠ¨é‡è¯•ç½‘ç»œé”™è¯¯
4. âœ… **è¾“å‡ºéªŒè¯**: è‡ªåŠ¨éªŒè¯å’Œè§£æ
5. âœ… **æ™ºèƒ½è§£æ**: å¤šç§è§£æç­–ç•¥
6. âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†

### ä»£ç è´¨é‡æå‡

- **å¯ç»´æŠ¤æ€§**: â¬†ï¸ æ›´æ¸…æ™°çš„ä»£ç ç»“æ„
- **å¯é æ€§**: â¬†ï¸ æ›´å¥½çš„é”™è¯¯å¤„ç†
- **æ€§èƒ½**: â¬†ï¸ æ›´å¿«çš„æ‰§è¡Œé€Ÿåº¦
- **æˆæœ¬**: â¬‡ï¸ æ›´å°‘çš„ API è°ƒç”¨
- **ç±»å‹å®‰å…¨**: â¬†ï¸ æ›´å¥½çš„ç±»å‹æç¤º

### å»ºè®®çš„åç»­ä¼˜åŒ–

1. ä½¿ç”¨ Pydantic æ¨¡å‹ç®¡ç†çŠ¶æ€
2. å¹¶è¡Œå¤„ç†ç‹¬ç«‹çš„æ“ä½œ
3. æ·»åŠ ç¼“å­˜æœºåˆ¶
4. æ·»åŠ ç›‘æ§å’ŒæŒ‡æ ‡
5. å®Œå–„æµ‹è¯•è¦†ç›–

ä»£ç å·²ç»è¿‡ä¸“ä¸šä¼˜åŒ–ï¼Œå…·å¤‡äº†ç”Ÿäº§çº§åˆ«çš„è´¨é‡å’Œå¥å£®æ€§ï¼ğŸš€
